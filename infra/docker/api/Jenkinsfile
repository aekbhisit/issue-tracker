pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
        PNPM_VERSION = '8.15.0'
        DOCKER_REGISTRY = 'your-registry.com'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        APP_NAME = 'api'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 20, unit: 'MINUTES')
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    sh '''
                        # Install Node.js
                        curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                        
                        # Install pnpm
                        npm install -g pnpm@${PNPM_VERSION}
                        
                        # Install OpenSSL for Prisma
                        sudo apt-get update
                        sudo apt-get install -y openssl
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    sh '''
                        # Install root dependencies
                        pnpm install --frozen-lockfile
                        
                        # Install API dependencies
                        cd apps/api
                        pnpm install --frozen-lockfile
                    '''
                }
            }
        }
        
        stage('Lint & Type Check') {
            steps {
                script {
                    sh '''
                        # Lint API
                        cd apps/api
                        pnpm lint
                        
                        # Type check API
                        pnpm typecheck
                    '''
                }
            }
        }
        
        stage('Database Setup') {
            steps {
                script {
                    sh '''
                        # Generate Prisma client
                        cd packages/database
                        pnpm prisma generate --schema=./prisma/schema
                    '''
                }
            }
        }
        
        stage('Build API') {
            steps {
                script {
                    sh '''
                        # Build API
                        cd apps/api
                        pnpm build
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    sh '''
                        # Build API Docker image
                        docker build -f apps/api/Dockerfile \
                            -t ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG} \
                            -t ${DOCKER_REGISTRY}/${APP_NAME}:latest \
                            .
                    '''
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                script {
                    sh '''
                        # Test the Docker image
                        docker run --rm -d --name test-${APP_NAME} \
                            -p 3000:3000 \
                            ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}
                        
                        # Wait for container to start
                        sleep 10
                        
                        # Test health endpoint
                        curl -f http://localhost:3000/health || exit 1
                        
                        # Stop test container
                        docker stop test-${APP_NAME}
                    '''
                }
            }
        }
        
        stage('Push Docker Image') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                }
            }
            steps {
                script {
                    sh '''
                        # Login to Docker registry
                        echo $DOCKER_PASSWORD | docker login ${DOCKER_REGISTRY} -u $DOCKER_USERNAME --password-stdin
                        
                        # Push API image
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}:latest
                        
                        # Logout from Docker registry
                        docker logout ${DOCKER_REGISTRY}
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Clean up Docker containers and images
                sh '''
                    # Remove test containers
                    docker ps -a --filter "name=test-${APP_NAME}" -q | xargs -r docker rm -f
                    
                    # Remove dangling images
                    docker image prune -f
                '''
            }
        }
        
        success {
            script {
                echo "‚úÖ API Build ${env.BUILD_NUMBER} completed successfully!"
                echo "üì¶ Image: ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}"
            }
        }
        
        failure {
            script {
                echo "‚ùå API Build ${env.BUILD_NUMBER} failed!"
            }
        }
        
        cleanup {
            cleanWs()
        }
    }
}
