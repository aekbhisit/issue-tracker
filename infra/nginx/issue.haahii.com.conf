# Site configuration for issue.haahii.com
# This file should be placed in /etc/nginx/sites-available/issue.haahii.com.conf
# and symlinked to /etc/nginx/sites-enabled/issue.haahii.com.conf
#
# Usage:
#   sudo cp infra/nginx/issue.haahii.com.conf /etc/nginx/sites-available/issue.haahii.com.conf
#   sudo ln -s /etc/nginx/sites-available/issue.haahii.com.conf /etc/nginx/sites-enabled/issue.haahii.com.conf
#   sudo nginx -t
#   sudo systemctl reload nginx
#
# NOTE: The map directive below should ideally be in /etc/nginx/nginx.conf http block
# If you get "map directive is not allowed here" error, move it to nginx.conf http block
# For now, we include it here for convenience (works in some Nginx versions)

# Smart routing for RSC requests
# Route root RSC requests (/?_rsc=...) to admin if they come from admin context
# This handles the Next.js limitation where RSC requests are always root-relative
map "$args:$http_referer" $rsc_backend {
    default "http://127.0.0.1:3412";  # Default: frontend
    ~^[^:]*_rsc=[^:]*:.*/admin "http://127.0.0.1:3411";  # RSC from admin → admin container
}

# HTTP server - redirects to HTTPS (managed by Certbot)
server {
    if ($host = issue.haahii.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name issue.haahii.com;
    return 404; # managed by Certbot
}

# HTTPS server - production configuration with SSL
server {
    listen 443 ssl; # managed by Certbot
    listen [::]:443 ssl; # managed by Certbot
    server_name issue.haahii.com;

    # SSL certificates (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/issue.haahii.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/issue.haahii.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Security headers for HTTPS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    # X-Content-Type-Options: nosniff - only add for non-static assets
    # Static assets (JS, CSS) should have correct Content-Type from backend
    # We'll add this header per-location for non-static content
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    client_max_body_size 50M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Rate limiting zones (must be defined before use)
    # Note: These should be defined in nginx.conf http block, but included here for reference
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=2r/s;

    # Error handler for API endpoints (used by /api/ routes)
    location @api_error {
        default_type application/json;
        return 503 '{"error":"ServiceUnavailable","message":"API service is temporarily unavailable. Please check container status.","status":503}';
    }

    # API endpoints
    # Proxies directly to API backend on localhost:3410
    location /api/ {
        # Rate limiting (uncomment if limit_req_zone is defined in nginx.conf)
        # limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://127.0.0.1:3410;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Error handling - return 503 if backend is unavailable
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 1;
        proxy_next_upstream_timeout 5s;
        
        # Error page for 502/503
        error_page 502 503 = @api_error;
        
        # CORS headers are handled by the API server
        # Remove these if API handles CORS internally
        # add_header Access-Control-Allow-Origin "$http_origin" always;
        # add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        # add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        # add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle preflight requests (if CORS headers above are enabled)
        # if ($request_method = 'OPTIONS') {
        #     return 204;
        # }
    }

    # Upload endpoints (rate limited, larger body size)
    location /api/admin/v1/upload/ {
        # Rate limiting (uncomment if limit_req_zone is defined in nginx.conf)
        # limit_req zone=upload_limit burst=5 nodelay;
        client_max_body_size 100M;
        
        proxy_pass http://127.0.0.1:3410;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeouts for file uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Static files (uploads) - served directly by nginx
    location /uploads/ {
        alias /usr/share/nginx/html/storage/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
    }

    # Public static files
    location /public/ {
        alias /usr/share/nginx/html/storage/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
    }

        # Admin Next.js static files with caching
    # With basePath: '/admin', Next.js generates HTML that references /admin/_next/static/
    # But Next.js container serves files at /_next/static/ (root level)
    # Use proxy_pass with trailing slash to automatically strip /admin/_next/static/ prefix
    location /admin/_next/static/ {
        # Nginx automatically strips /admin/_next/static/ prefix and appends to proxy_pass URL
        # /admin/_next/static/chunks/main.js → http://127.0.0.1:3411/_next/static/chunks/main.js
        proxy_pass http://127.0.0.1:3411/_next/static/;
        proxy_http_version 1.1;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Don't override Content-Type - let backend set it correctly
        # This prevents "nosniff" errors when Content-Type is wrong
        proxy_hide_header Content-Type;
        proxy_pass_header Content-Type;
    }

    # Fallback: Root-level /_next/static/ requests from admin context
    # This handles cases where Next.js still generates root-relative asset paths
    # Check Referer header to route admin requests to admin container
    # ⚠️ This must come BEFORE the general /_next/static/ location for frontend
    # Use regex match to catch all /_next/static/* paths (not just exact /_next/static/)
    location ~ ^/_next/static/ {
        # Fallback handler for both admin and frontend static assets
        # Use variable backend to avoid proxy_pass URI restriction in regex locations
        set $next_static_backend http://127.0.0.1:3412;
        if ($http_referer ~ "/admin") {
            set $next_static_backend http://127.0.0.1:3411;
        }

        proxy_pass $next_static_backend;
        
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Don't override Content-Type - let backend set it correctly
        proxy_hide_header Content-Type;
        proxy_pass_header Content-Type;
    }

    # Admin Next.js image optimization endpoint
    # Next.js with basePath generates /admin/_next/image but container serves at /_next/image
    # Use proxy_pass with path to automatically strip /admin/_next/image prefix
    location /admin/_next/image {
        # Nginx automatically strips /admin/_next/image prefix and appends to proxy_pass URL
        # /admin/_next/image?url=... → http://127.0.0.1:3411/_next/image?url=...
        proxy_pass http://127.0.0.1:3411/_next/image;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve Content-Type from backend
        proxy_hide_header Content-Type;
        proxy_pass_header Content-Type;
    }

    # Admin static assets from public folder (images, etc.)
    # Next.js serves files from public/ at root, so /images/ in admin becomes /admin/images/ or /images/
    # Handle both /admin/images/ and root /images/ (for admin app)
    location /admin/images/ {
        proxy_pass http://127.0.0.1:3411/images/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Root-level /images/ for admin app (when components use root-relative paths)
    # This must come BEFORE the general /images/ location below
    # We'll try admin first, but this might conflict with frontend
    # Better solution: Update admin app to use /admin/images/ paths

    # Collector SDK - serve from admin container's public folder
    # This allows the SDK to be embedded in any website
    # Access at: https://issue.haahii.com/collector.min.js
    # ⚠️ IMPORTANT: This must come BEFORE the catch-all location / block
    location = /collector.min.js {
        proxy_pass http://127.0.0.1:3411/collector.min.js;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache the SDK file (it's versioned, so long cache is safe)
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header Vary "Accept-Encoding" always;
        
        # CORS headers - allow SDK to be loaded from any origin
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
        
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;
            add_header Access-Control-Max-Age 86400;
            add_header Content-Type "text/plain charset=UTF-8";
            add_header Content-Length 0;
            return 204;
        }
        
        # Error handling - return 503 if backend is unavailable
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 1;
        proxy_next_upstream_timeout 5s;
        
        # Error page for 502/503
        error_page 502 503 = @sdk_error;
    }
    
    # Error handler for SDK endpoint
    location @sdk_error {
        default_type application/javascript;
        return 503 'console.error("Issue Collector SDK: Service temporarily unavailable. Please try again later.");';
    }

    # Admin other static assets from public folder
    # Admin static files from public folder (favicon, robots.txt, images, etc.)
    # Next.js serves public/ folder at root, so /admin/favicon.ico needs to be proxied as /favicon.ico
    location ~ ^/admin/(favicon\.ico|robots\.txt|sitemap\.xml|.*\.(ico|png|jpg|jpeg|gif|svg|webp))$ {
        # Rewrite /admin/favicon.ico to /favicon.ico for Next.js
        rewrite ^/admin/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3411;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    
    # Fix double /admin/admin/ paths - rewrite to single /admin/
    # This handles cases where paths still have /admin/ prefix even with basePath
    # Examples: /admin/admin/dashboard, /admin/admin/issues?_rsc=...
    # ⚠️ This must come BEFORE /admin location block to catch double prefix first
    # Use rewrite instead of redirect to avoid breaking RSC requests
    # RSC requests (with ?_rsc=) need to be proxied directly, not redirected
    location ~ ^/admin/admin/(.*)$ {
        # Rewrite /admin/admin/* to /admin/* and proxy to backend
        # This preserves query strings (including ?_rsc=) and avoids redirect loops
        rewrite ^/admin/admin/(.*)$ /admin/$1 break;
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept $http_accept;
        
        # RSC indicator header
        set $rsc_header "";
        if ($args ~ "_rsc=") {
            set $rsc_header "1";
        }
        proxy_set_header RSC $rsc_header;
        
        # No cache for RSC requests
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        proxy_redirect off;
        proxy_buffering off;
    }

    # Admin Next.js other _next paths (catch-all for /admin/_next/* that aren't static or image)
    # This handles RSC requests, server components, etc.
    # Examples: /admin/_next/data/*, /admin/_next/server/*, etc.
    # ⚠️ This must come AFTER /admin/_next/static/ and /admin/_next/image (prefix matches have priority)
    # Next.js container serves at /_next/* (root level), so strip /admin prefix
    location ~ ^/admin/_next/ {
        # Strip /admin prefix - rewrite /admin/_next/* to /_next/*
        rewrite ^/admin/_next/(.*)$ /_next/$1 break;
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_redirect off;
        proxy_buffering off;
        
        # Preserve Content-Type from backend
        proxy_hide_header Content-Type;
        proxy_pass_header Content-Type;
    }

    # Admin dashboard - Next.js app (handles both regular and RSC requests)
    # Proxies directly to Admin backend on 127.0.0.1:3411
    # Access at: http://issue.haahii.com/admin
    # This location must come AFTER /admin/_next/ to allow static assets to be handled first
    # Next.js 15 RSC requests use ?_rsc= query parameter and are handled here
    location /admin {
        # Add X-Content-Type-Options for non-static content (HTML pages)
        add_header X-Content-Type-Options "nosniff" always;
        
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve original Accept header for RSC requests
        # Next.js sends "text/x-component" for RSC requests
        proxy_set_header Accept $http_accept;
        
        # RSC indicator header (Next.js may check this)
        # Set conditionally if query string contains _rsc=
        set $rsc_header "";
        if ($args ~ "_rsc=") {
            set $rsc_header "1";
        }
        proxy_set_header RSC $rsc_header;
        
        # Cache control - RSC requests should not be cached
        # Apply no-cache to all /admin requests (simpler than conditional)
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Next.js specific settings
        proxy_redirect off;
        proxy_buffering off;
        
        # Timeouts for Next.js requests (including RSC)
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
    }

    # Static images at root level (/images/)
    # ⚠️ IMPORTANT: Admin app uses root-relative paths like /images/logo/logo-icon.svg
    # Next.js assetPrefix only affects _next/static, not public/ folder files
    # So /images/ requests from admin app need to be proxied to admin container (port 3411)
    # If frontend also uses /images/, it should use a different path or this will conflict
    location /images/ {
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Error handling: If admin container is down, this will return 502
        # Check container status: docker ps | grep issue-collector-admin
    }

    # Frontend - Next.js app (handles both regular and RSC requests)
    # Proxies directly to Frontend backend on 127.0.0.1:3412
    # Access at: https://issue.haahii.com
    # This must come AFTER /images/ to allow static assets to be handled first
    # Next.js 15 RSC requests use ?_rsc= query parameter and are handled here
    # 
    # SMART ROUTING: Root RSC requests (/?_rsc=...) from admin context are routed to admin container
    # This handles the Next.js limitation where RSC requests are always root-relative
    # The $rsc_backend variable is set by the map directive above
    location / {
        proxy_pass $rsc_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve original Accept header for RSC requests
        # Next.js sends "text/x-component" for RSC requests
        proxy_set_header Accept $http_accept;
        
        # RSC indicator header (Next.js may check this)
        # Set conditionally if query string contains _rsc=
        set $rsc_header "";
        if ($args ~ "_rsc=") {
            set $rsc_header "1";
        }
        proxy_set_header RSC $rsc_header;
        
        # Timeouts for Next.js requests (including RSC)
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Error handling - return 503 if backend is unavailable
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 1;
        proxy_next_upstream_timeout 5s;
        
        # Cache control - RSC requests should not be cached
        # Apply no-cache to all / requests (simpler than conditional)
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Next.js specific settings
        proxy_redirect off;
        proxy_buffering off;
        
        # Error page for 502/503
        error_page 502 503 = @frontend_error;
    }
    
    # Error handler for frontend endpoints
    location @frontend_error {
        default_type text/html;
        return 503 '<!DOCTYPE html><html><head><title>Service Unavailable</title></head><body><h1>503 Service Unavailable</h1><p>Frontend service is temporarily unavailable. Please check container status.</p></body></html>';
    }

    # Frontend Next.js static assets (_next/static)
    # ⚠️ NOTE: This location is now handled by the regex match above
    # The regex location ~ ^/_next/static/ handles both admin and frontend requests
    # based on Referer header, so this location block is no longer needed
    # Keeping it commented for reference
    # location /_next/static/ {
    #     proxy_pass http://127.0.0.1:3412;
    #     proxy_http_version 1.1;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     expires 1y;
    #     add_header Cache-Control "public, max-age=31536000, immutable";
    #     add_header Vary "Accept-Encoding";
    # }

    # Frontend Next.js images
    location /_next/image {
        proxy_pass http://127.0.0.1:3412;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Security: Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /(package\.json|yarn\.lock|pnpm-lock\.yaml|\.env.*|\.git.*) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Logging configuration
    # Uncomment and configure paths as needed
    # access_log /var/log/nginx/issue.haahii.com.access.log;
    # error_log /var/log/nginx/issue.haahii.com.error.log warn;
}

# Note: HTTPS server block is now active above with Certbot-managed SSL certificates
# All location blocks are configured in the HTTPS server block above
