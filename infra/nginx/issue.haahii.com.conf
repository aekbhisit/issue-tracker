# Site configuration for issue.haahii.com
# This file should be placed in /etc/nginx/sites-available/issue.haahii.com.conf
# and symlinked to /etc/nginx/sites-enabled/issue.haahii.com.conf
#
# Usage:
#   sudo cp infra/nginx/issue.haahii.com.conf /etc/nginx/sites-available/issue.haahii.com.conf
#   sudo ln -s /etc/nginx/sites-available/issue.haahii.com.conf /etc/nginx/sites-enabled/issue.haahii.com.conf
#   sudo nginx -t
#   sudo systemctl reload nginx

# HTTP server - redirects to HTTPS (managed by Certbot)
server {
    if ($host = issue.haahii.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name issue.haahii.com;
    return 404; # managed by Certbot
}

# HTTPS server - production configuration with SSL
server {
    listen 443 ssl; # managed by Certbot
    listen [::]:443 ssl; # managed by Certbot
    server_name issue.haahii.com;

    # SSL certificates (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/issue.haahii.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/issue.haahii.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Security headers for HTTPS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    client_max_body_size 50M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Rate limiting zones (must be defined before use)
    # Note: These should be defined in nginx.conf http block, but included here for reference
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=2r/s;

    # Error handler for API endpoints (used by /api/ routes)
    location @api_error {
        default_type application/json;
        return 503 '{"error":"ServiceUnavailable","message":"API service is temporarily unavailable. Please check container status.","status":503}';
    }

    # API endpoints
    # Proxies directly to API backend on localhost:3410
    location /api/ {
        # Rate limiting (uncomment if limit_req_zone is defined in nginx.conf)
        # limit_req zone=api_limit burst=20 nodelay;
        
        proxy_pass http://127.0.0.1:3410;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Error handling - return 503 if backend is unavailable
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 1;
        proxy_next_upstream_timeout 5s;
        
        # Error page for 502/503
        error_page 502 503 = @api_error;
        
        # CORS headers are handled by the API server
        # Remove these if API handles CORS internally
        # add_header Access-Control-Allow-Origin "$http_origin" always;
        # add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        # add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept" always;
        # add_header Access-Control-Allow-Credentials "true" always;
        
        # Handle preflight requests (if CORS headers above are enabled)
        # if ($request_method = 'OPTIONS') {
        #     return 204;
        # }
    }

    # Upload endpoints (rate limited, larger body size)
    location /api/admin/v1/upload/ {
        # Rate limiting (uncomment if limit_req_zone is defined in nginx.conf)
        # limit_req zone=upload_limit burst=5 nodelay;
        client_max_body_size 100M;
        
        proxy_pass http://127.0.0.1:3410;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeouts for file uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Static files (uploads) - served directly by nginx
    location /uploads/ {
        alias /usr/share/nginx/html/storage/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "SAMEORIGIN";
    }

    # Public static files
    location /public/ {
        alias /usr/share/nginx/html/storage/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
    }

    # Admin Next.js static files with caching
    # With basePath: '/admin', Next.js expects requests with /admin prefix
    # Preserve full path so Next.js can handle basePath routing internally
    location /admin/_next/static/ {
        proxy_pass http://127.0.0.1:3411;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Admin Next.js images
    location /admin/_next/image {
        proxy_pass http://127.0.0.1:3411;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Admin static assets from public folder (images, etc.)
    # Next.js serves files from public/ at root, so /images/ in admin becomes /admin/images/ or /images/
    # Handle both /admin/images/ and root /images/ (for admin app)
    location /admin/images/ {
        proxy_pass http://127.0.0.1:3411/images/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Root-level /images/ for admin app (when components use root-relative paths)
    # This must come BEFORE the general /images/ location below
    # We'll try admin first, but this might conflict with frontend
    # Better solution: Update admin app to use /admin/images/ paths

    # Admin other static assets from public folder
    # Admin static files from public folder (favicon, robots.txt, images, etc.)
    # Next.js serves public/ folder at root, so /admin/favicon.ico needs to be proxied as /favicon.ico
    location ~ ^/admin/(favicon\.ico|robots\.txt|sitemap\.xml|.*\.(ico|png|jpg|jpeg|gif|svg|webp))$ {
        # Rewrite /admin/favicon.ico to /favicon.ico for Next.js
        rewrite ^/admin/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3411;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    
    # Admin Next.js other _next paths (images, media, etc.)
    location ~ ^/admin/_next/ {
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_redirect off;
        proxy_buffering off;
    }

    # Admin dashboard - Next.js app (handles both regular and RSC requests)
    # Proxies directly to Admin backend on 127.0.0.1:3411
    # Access at: http://issue.haahii.com/admin
    # This location must come AFTER /admin/_next/ to allow static assets to be handled first
    # Next.js 15 RSC requests use ?_rsc= query parameter and are handled here
    location /admin {
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve original Accept header for RSC requests
        # Next.js sends "text/x-component" for RSC requests
        proxy_set_header Accept $http_accept;
        
        # RSC indicator header (Next.js may check this)
        # Set conditionally if query string contains _rsc=
        set $rsc_header "";
        if ($args ~ "_rsc=") {
            set $rsc_header "1";
        }
        proxy_set_header RSC $rsc_header;
        
        # Cache control - RSC requests should not be cached
        # Apply no-cache to all /admin requests (simpler than conditional)
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Next.js specific settings
        proxy_redirect off;
        proxy_buffering off;
        
        # Timeouts for Next.js requests (including RSC)
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
    }

    # Static images at root level (/images/)
    # ⚠️ IMPORTANT: Admin app uses root-relative paths like /images/logo/logo-icon.svg
    # Next.js assetPrefix only affects _next/static, not public/ folder files
    # So /images/ requests from admin app need to be proxied to admin container (port 3411)
    # If frontend also uses /images/, it should use a different path or this will conflict
    location /images/ {
        proxy_pass http://127.0.0.1:3411;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Error handling: If admin container is down, this will return 502
        # Check container status: docker ps | grep issue-collector-admin
    }

    # Frontend - Next.js app (handles both regular and RSC requests)
    # Proxies directly to Frontend backend on 127.0.0.1:3412
    # Access at: https://issue.haahii.com
    # This must come AFTER /images/ to allow static assets to be handled first
    # Next.js 15 RSC requests use ?_rsc= query parameter and are handled here
    location / {
        proxy_pass http://127.0.0.1:3412;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Preserve original Accept header for RSC requests
        # Next.js sends "text/x-component" for RSC requests
        proxy_set_header Accept $http_accept;
        
        # RSC indicator header (Next.js may check this)
        # Set conditionally if query string contains _rsc=
        set $rsc_header "";
        if ($args ~ "_rsc=") {
            set $rsc_header "1";
        }
        proxy_set_header RSC $rsc_header;
        
        # Timeouts for Next.js requests (including RSC)
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Error handling - return 503 if backend is unavailable
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 1;
        proxy_next_upstream_timeout 5s;
        
        # Cache control - RSC requests should not be cached
        # Apply no-cache to all / requests (simpler than conditional)
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Next.js specific settings
        proxy_redirect off;
        proxy_buffering off;
        
        # Error page for 502/503
        error_page 502 503 = @frontend_error;
    }
    
    # Error handler for frontend endpoints
    location @frontend_error {
        default_type text/html;
        return 503 '<!DOCTYPE html><html><head><title>Service Unavailable</title></head><body><h1>503 Service Unavailable</h1><p>Frontend service is temporarily unavailable. Please check container status.</p></body></html>';
    }

    # Frontend Next.js static assets (_next/static)
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3412;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
    }

    # Frontend Next.js images
    location /_next/image {
        proxy_pass http://127.0.0.1:3412;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Security: Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /(package\.json|yarn\.lock|pnpm-lock\.yaml|\.env.*|\.git.*) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Logging configuration
    # Uncomment and configure paths as needed
    # access_log /var/log/nginx/issue.haahii.com.access.log;
    # error_log /var/log/nginx/issue.haahii.com.error.log warn;
}

# Note: HTTPS server block is now active above with Certbot-managed SSL certificates
# All location blocks are configured in the HTTPS server block above
